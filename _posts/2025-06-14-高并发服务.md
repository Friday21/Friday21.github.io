---
layout:     post
title:      计算机原理101: 高并发服务
date:       2025-05-01
author:     "FridayLi"
catalog: true
tags:
  - 操作系统
---

# 计算机原理101:  高并发服务

>《计算机底层的秘密》读书笔记 + GPT问答整理

## I/O 多路复用 + 事件循环 + 多线程
![描述](/img/2025/007.jpg)

| 组件        | 职责              |
| --------- | --------------- |
| **epoll** | 高效检测 I/O 准备状态   |
| **事件循环**  | 调度任务、协程、回调执行    |
| **线程池**   | 异步 offload 耗时任务 |

这套模型实现了 高并发、低资源消耗、响应迅速 的目标，是现代服务器架构（如 Nginx、Node.js、Python Tornado）的核心。

### 一、I/O 多路复用（以 epoll 为代表）
✅ 概念：
I/O 多路复用是一种单线程监听多个 I/O 事件的技术，核心是：
“一个线程用一个系统调用就能监听多个 socket 的可读/可写状态，而不用为每个连接开一个线程。”

📌 典型代表：
* Linux：epoll
* macOS：kqueue
* Windows：IOCP
* 跨平台：libuv, libevent

```python
while (true) {
    ready_list = epoll_wait(epoll_fd, ...);  // 阻塞直到某些 I/O 准备好
    for each fd in ready_list:
        handle_event(fd);
}
```
✅ 优点：
* 非阻塞：不会因为单个 I/O 阻塞
* 高并发：1 个线程可管理数万个连接
常用于网络服务器、异步框架（如 Nginx、Redis）

### 二、事件循环（Event Loop）
事件循环是一个调度机制，用于：
> 不断轮询任务队列与 I/O 事件，按顺序分发给对应的回调/协程执行。
它是高效异步编程的调度器，常见于：
* 单线程模型中（Node.js, Python asyncio）
* 异步协程系统（Kotlin coroutines, libuv）

```python
while True:
    ready_futures = poll_io_events()     # 依赖 epoll
    run_ready_callbacks(ready_futures)   # 恢复协程或执行回调
```
**事件循环中一定不能调用任何阻塞式的接口**

### 三、多线程（Thread Pool）
epoll + 事件循环负责监听和分发；
多线程处理任务，完成后回调通知事件循环；


### 四、加上协程
![描述](/img/2025/008.jpg)

协程挂起后并不会阻塞工作线程， 这是协程和利用线程进行阻塞式调用的最大区别。
